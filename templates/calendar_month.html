{% extends "_layout.html" %}
{% block body %}
<h1 class="h1 center">달력(월간)</h1>
<a class="back" href="/">← 홈</a>

<div class="card">
  <div class="cal-head">
    <a class="cal-nav" href="/page/calendar/month?year={{ year-1 if month==1 else year }}&month={{ 12 if month==1 else month-1 }}">◀</a>
    <div class="cal-title">{{year}}년 {{month}}월</div>
    <a class="cal-nav" href="/page/calendar/month?year={{ year+1 if month==12 else year }}&month={{ 1 if month==12 else month+1 }}">▶</a>
  </div>

  <table class="cal">
    <thead>
      <tr><th>일</th><th>월</th><th>화</th><th>수</th><th>목</th><th>금</th><th>토</th></tr>
    </thead>
    <tbody>
      {# build month grid in template #}
      {% set first = (year|string) ~ "-" ~ ("%02d"|format(month)) ~ "-01" %}
      {% set first_dt = first|tojson %}
    </tbody>
  </table>

  {# JS renders grid and memo chips; server provides memos dict #}
  <div class="mt">
    <form method="post" action="/page/calendar/memo">
      <label>날짜 <input type="date" name="memo_date" value="{{today}}" required></label>
      <label>작성자 <input name="author" placeholder="이름(선택)"></label>
      <label>메모 <textarea name="memo" rows="3" placeholder="메모 입력" required></textarea></label>
      <button class="btn" type="submit">메모 추가</button>
    </form>
  </div>
</div>

<script>
(function(){
  const year={{year}}, month={{month}};
  const memos={{memos|tojson}};
  function pad(n){return (n<10?'0':'')+n}
  const first = new Date(year, month-1, 1);
  const startDay = first.getDay(); // 0=Sun
  const last = new Date(year, month, 0);
  const daysInMonth = last.getDate();

  const tbody = document.querySelector(".cal tbody");
  tbody.innerHTML = "";
  let day=1;
  for(let r=0;r<6;r++){
    let tr=document.createElement("tr");
    for(let c=0;c<7;c++){
      let td=document.createElement("td");
      if(r===0 && c<startDay){ td.innerHTML=""; }
      else if(day>daysInMonth){ td.innerHTML=""; }
      else{
        const dkey = `${year}-${pad(month)}-${pad(day)}`;
        td.innerHTML = `<div class="cal-day">${day}</div>`;
        const list = memos[dkey] || [];
        if(list.length>0){
          const chip = document.createElement("div");
          chip.className="chip";
          chip.textContent = "메모 " + list.length;
          td.appendChild(chip);
        }
        td.onclick = ()=>{
          const dateInput=document.querySelector('input[name="memo_date"]');
          dateInput.value = dkey;
          dateInput.scrollIntoView({behavior:'smooth', block:'center'});
        };
        day++;
      }
      tr.appendChild(td);
    }
    tbody.appendChild(tr);
    if(day>daysInMonth) break;
  }
})();
</script>
{% endblock %}
