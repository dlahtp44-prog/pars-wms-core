<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>ë„ì°© ë¡œì¼€ì´ì…˜ QR</title>
<script src="https://unpkg.com/html5-qrcode"></script>
<style>
  body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; padding:16px; }
  button {
    width:100%; padding:14px; font-size:16px;
    border-radius:8px; border:none;
    background:#0a7cff; color:#fff; font-weight:600;
    margin-bottom:12px;
  }
  #reader { width:300px; height:300px; margin:0 auto; }
</style>
</head>

<body>

<h3>ğŸ“ ë„ì°© ë¡œì¼€ì´ì…˜ QR ìŠ¤ìº”</h3>

<button id="startScan" type="button">ğŸ“· QR ìŠ¤ìº” ì‹œì‘</button>

<div id="reader"></div>

<form id="moveForm" method="post" action="/m/qr/move/complete">
  <input type="hidden" name="from_location" value="{{ from_location }}">
  <input type="hidden" name="item_code" value="{{ item_code }}">
  <input type="hidden" name="item_name" value="{{ item_name }}">
  <input type="hidden" name="lot" value="{{ lot }}">
  <input type="hidden" name="spec" value="{{ spec }}">
  <input type="hidden" name="qty" value="{{ qty }}">
  <input type="hidden" name="to_location" id="to_location">
</form>

<script>
const form = document.getElementById("moveForm");

/* âŒ ê¸°ë³¸ submit ì™„ì „ ì°¨ë‹¨ */
form.addEventListener("submit", e => e.preventDefault());

const qr = new Html5Qrcode("reader");

document.getElementById("startScan").addEventListener("click", () => {
  qr.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    (decodedText) => {
      qr.stop();

      let location = decodedText.trim();
      if (location.includes(":")) location = location.split(":").pop();
      if (location.includes("|")) location = location.split("|").pop();
      if (location.startsWith("http")) location = location.split("/").pop();

      location = location.trim();
      if (!location) {
        alert("ë„ì°© ë¡œì¼€ì´ì…˜ ì¸ì‹ ì‹¤íŒ¨");
        return;
      }

      document.getElementById("to_location").value = location;

      /* âœ… QR ì¸ì‹ ì„±ê³µ ì‹œì—ë§Œ submit */
      form.submit();
    }
  ).catch(err => {
    alert("ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨ (ê¶Œí•œ/HTTPS í™•ì¸)");
    console.error(err);
  });
});
</script>

</body>
</html>
