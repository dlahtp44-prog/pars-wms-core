{% extends "_layout_calendar.html" %}
{% block body_calendar %}
<h1>달력(월간)</h1>
<div class="badge"><a href="/" style="text-decoration:none;color:var(--primary);font-weight:600;">← 홈</a></div>

<div class="calendar-wrap" style="margin-top:10px;">
  <div class="calendar-header">
    <a href="/page/calendar/month?year={{ prev_year }}&month={{ prev_month }}">◀</a>
    <span>{{ year }}년 {{ month }}월</span>
    <a href="/page/calendar/month?year={{ next_year }}&month={{ next_month }}">▶</a>
  </div>

  <div class="calendar-grid">
    {% set wds = ["일","월","화","수","목","금","토"] %}
    {% for wd in wds %}
      <div class="calendar-cell calendar-weekday">{{ wd }}</div>
    {% endfor %}

    {% for week in weeks %}
      {% for d in week %}
        <div class="calendar-cell">
          {% if d != 0 %}
            <div class="daynum">
              <span>{{ d }}</span>
              {% set ymd = "%04d-%02d-%02d"|format(year, month, d) %}
              {% if ymd == today_ymd %}
                <span class="tag-today">오늘</span>
              {% endif %}
            </div>

            {% if memos_by_day.get(d) %}
              {% for m in memos_by_day.get(d)[:3] %}
                <div class="memo">
                  {% if m.author %}<span class="author">[{{ m.author }}]</span> {% endif %}
                  {{ m.memo }}
                </div>
              {% endfor %}
              {% if memos_by_day.get(d)|length > 3 %}
                <div class="memo author">+ {{ memos_by_day.get(d)|length - 3 }}건</div>
              {% endif %}
            {% else %}
              <div class="memo author">-</div>
            {% endif %}
          {% endif %}
        </div>
      {% endfor %}
    {% endfor %}
  </div>

  <div class="memo-add">
    <form id="memoForm">
      <div class="grid">
        <div class="form-row">
          <span>날짜</span>
          <input class="input" type="date" name="ymd" value="{{ today_ymd }}" required>
        </div>
        <div class="form-row">
          <span>작성자</span>
          <input class="input" name="author" placeholder="이름(선택)">
        </div>
        <div class="form-row">
          <span>메모</span>
          <textarea class="input" name="memo" rows="3" placeholder="메모 입력" required></textarea>
        </div>
        <button class="btn" type="submit">메모 추가</button>
        <div id="msg" class="badge"></div>
      </div>
    </form>
  </div>
</div>
{% endblock %}
{% block script %}
<script>
document.getElementById('memoForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const fd = new FormData(e.target);
  const r = await fetch('/api/calendar/memo', {method:'POST', body: fd});
  const t = await r.json().catch(()=>({}));
  const msg = document.getElementById('msg');
  if(r.ok){ msg.textContent='저장 완료 (새로고침 됩니다)'; setTimeout(()=>location.reload(), 350); }
  else{ msg.textContent='오류: ' + (t.detail || r.status); }
});
</script>
{% endblock %}
