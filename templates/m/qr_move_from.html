<!DOCTYPE html>
<html lang="ko">
<head>
  <title>QR 이동 - 출발 스캔</title>
  {% include "m/_qr_common_head.html" %}
</head>
<body>
  <div class="card">
    <h2>🚚 QR 이동 (1/2) - 출발 로케이션 스캔</h2>
    <div id="reader"></div>

    <form method="GET" action="/m/qr/move/select">
      <input type="text" id="from_location" name="from_location" placeholder="출발 로케이션" readonly required>
      <button type="submit">다음 (상품 선택)</button>
    </form>

    <button class="secondary" onclick="startScan()">스캔 시작</button>
    <div class="muted">· QR 값이 URL 형태여도 마지막 구간을 로케이션으로 인식합니다.</div>
  </div>

  <div class="card">
    <button class="secondary" onclick="location.href='/m'">← 모바일 홈</button>
  </div>

  <script>
    let html5QrCode = null;
    function extractLocation(text){
      if(!text) return "";
      if(text.startsWith("http")){
        const parts = text.split("/");
        return parts[parts.length-1];
      }
      return text;
    }
    function startScan(){
      if(html5QrCode) return;
      html5QrCode = new Html5Qrcode("reader");
      Html5Qrcode.getCameras().then(devices=>{
        if(!devices||devices.length===0){alert("카메라를 찾을 수 없습니다.");return;}
        html5QrCode.start(devices[0].id,{fps:10,qrbox:250},(qrText)=>{
          document.getElementById("from_location").value = extractLocation(qrText).replace(/\s/g, "");
          html5QrCode.stop().then(()=>{html5QrCode.clear();html5QrCode=null;});
        });
      }).catch(err=>{console.error(err);alert("카메라 권한을 확인해 주세요.");});
    }
  </script>
</body>
</html>
