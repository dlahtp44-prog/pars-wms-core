<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="/static/app.css"/>
  <title>ìº˜ë¦°ë” | PARS WMS</title>
  <style>
    .cal-wrap{max-width:1200px;margin:24px auto; padding:0 12px;}
    .cal-head{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px;}
    .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;}
    .cal-cell{border:1px solid #2a2a2a;border-radius:10px;min-height:92px;padding:8px;background:#111;}
    .cal-cell .d{font-weight:700;font-size:14px;opacity:.9}
    .cal-cell .tag{margin-top:6px;font-size:12px;opacity:.8}
    .cal-cell button{all:unset;cursor:pointer;display:block;width:100%;height:100%;}
    .cal-side{border:1px solid #2a2a2a;border-radius:12px;background:#0f0f0f;padding:12px;max-width:420px;width:100%;}
    .layout{display:grid;grid-template-columns:1fr 420px;gap:12px;}
    @media (max-width: 980px){ .layout{grid-template-columns:1fr;} .cal-side{max-width:none;} }
    textarea{width:100%; max-width:100%; box-sizing:border-box; resize:none; height:90px; overflow:auto;}
    .memo-item{border:1px solid #2a2a2a;border-radius:10px;padding:10px;margin-top:8px;}
    .memo-meta{font-size:12px;opacity:.75;margin-bottom:6px;}
  </style>
</head>
<body>
<div class="cal-wrap">
  <div class="cal-head">
    <div>
      <h2 style="margin:0;">ğŸ“… ìº˜ë¦°ë” ë©”ëª¨</h2>
      <div class="small">ë¡œê·¸ì¸: <b>{{ user.username }}</b> (<a href="/logout">ë¡œê·¸ì•„ì›ƒ</a>)</div>
    </div>
    <div style="display:flex; gap:8px; align-items:center;">
      <a class="btn" href="/page/calendar?year={{ prev_y }}&month={{ prev_m }}">â—€ ì´ì „ë‹¬</a>
      <div style="min-width:160px;text-align:center;font-weight:700;">{{ year }}-{{ "%02d"|format(month) }}</div>
      <a class="btn" href="/page/calendar?year={{ next_y }}&month={{ next_m }}">ë‹¤ìŒë‹¬ â–¶</a>
      <a class="btn" href="/">í™ˆ</a>
    </div>
  </div>

  <div class="layout">
    <div>
      <div class="cal-grid" style="margin-bottom:8px; opacity:.85;">
        <div class="small">ì¼</div><div class="small">ì›”</div><div class="small">í™”</div><div class="small">ìˆ˜</div><div class="small">ëª©</div><div class="small">ê¸ˆ</div><div class="small">í† </div>
      </div>

      <div class="cal-grid">
        {% for week in grid %}
          {% for d in week %}
            {% if d == 0 %}
              <div class="cal-cell" style="opacity:.35;"></div>
            {% else %}
              {% set ds = year|string + "-" + ("%02d"|format(month)) + "-" + ("%02d"|format(d)) %}
              <div class="cal-cell" data-date="{{ ds }}">
                <button type="button" onclick="selectDate('{{ ds }}')">
                  <div class="d">{{ d }}</div>
                  {% if counts.get(ds) %}
                    <div class="tag">ğŸ“ ë©”ëª¨ {{ counts.get(ds) }}ê±´</div>
                  {% else %}
                    <div class="tag" style="opacity:.55;">ë©”ëª¨ ì—†ìŒ</div>
                  {% endif %}
                </button>
              </div>
            {% endif %}
          {% endfor %}
        {% endfor %}
      </div>
    </div>

    <div class="cal-side">
      <h3 style="margin-top:0;">ì„ íƒ ë‚ ì§œ</h3>
      <div id="selDate" style="font-weight:700;">(ë‚ ì§œë¥¼ í´ë¦­í•˜ì„¸ìš”)</div>

      <div style="margin-top:10px;">
        <label class="small">ë©”ëª¨ ì¶”ê°€</label>
        <textarea id="memoText" placeholder="ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”. (ë°•ìŠ¤ëŠ” ê°€ë¡œë¡œ ëŠ˜ì–´ë‚˜ì§€ ì•ŠìŠµë‹ˆë‹¤)"></textarea>
        <button onclick="saveMemo()" style="margin-top:8px;">ì €ì¥</button>
      </div>

      <div style="margin-top:12px;">
        <div style="display:flex;align-items:center;justify-content:space-between;">
          <h3 style="margin:0;">ë©”ëª¨ ëª©ë¡</h3>
          <button type="button" onclick="refreshMemos()">ìƒˆë¡œê³ ì¹¨</button>
        </div>
        <div id="memoList" style="margin-top:8px;"></div>
      </div>
    </div>
  </div>
</div>

<script>
  let currentDate = "";

  function selectDate(ds){
    currentDate = ds;
    document.getElementById("selDate").textContent = ds;
    document.getElementById("memoText").value = "";
    refreshMemos();
  }

  async function refreshMemos(){
    const list = document.getElementById("memoList");
    list.innerHTML = "";
    if(!currentDate) return;

    const res = await fetch(`/api/calendar/memos?memo_date=${encodeURIComponent(currentDate)}`);
    if(!res.ok){
      list.innerHTML = "<div class='small'>ë¡œê·¸ì¸ì´ í•„ìš”í•˜ê±°ë‚˜ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>";
      return;
    }
    const data = await res.json();
    if(!data.length){
      list.innerHTML = "<div class='small'>ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤.</div>";
      return;
    }
    for(const m of data){
      const div = document.createElement("div");
      div.className = "memo-item";
      div.innerHTML = `
        <div class="memo-meta">ì‘ì„±: <b>${escapeHtml(m.created_by)}</b> / ${escapeHtml(m.created_at)}</div>
        <div style="white-space:pre-wrap; word-break:break-word;">${escapeHtml(m.content)}</div>
      `;
      list.appendChild(div);
    }
  }

  async function saveMemo(){
    if(!currentDate){
      alert("ë‚ ì§œë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.");
      return;
    }
    const text = document.getElementById("memoText").value.trim();
    if(!text){
      alert("ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
      return;
    }
    const fd = new FormData();
    fd.append("memo_date", currentDate);
    fd.append("content", text);

    const res = await fetch("/api/calendar/memos", { method:"POST", body: fd });
    if(!res.ok){
      alert("ì €ì¥ ì‹¤íŒ¨: ë¡œê·¸ì¸ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.");
      return;
    }
    alert("ì €ì¥ ì™„ë£Œ");
    window.location.reload(); // counts ê°±ì‹ ì„ ìœ„í•´ ë¦¬ë¡œë“œ
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
</script>
</body>
</html>
