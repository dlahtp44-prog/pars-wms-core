
{% extends "_base.html" %}
{% set title = "QR ìŠ¤ìº”" %}
{% block content %}
<div class="card">
  <h3>QR ìŠ¤ìº”</h3>
  <p class="hint">ì¹´ë©”ë¼ ê¶Œí•œì„ í—ˆìš©í•˜ì„¸ìš”. ìŠ¤ìº” í›„ ìë™ìœ¼ë¡œ íŒŒì‹±ë©ë‹ˆë‹¤.</p>

  <div class="row">
    <div>
      <label>ìŠ¤ìº” ê²°ê³¼</label>
      <input id="qrText" placeholder="ìŠ¤ìº” ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤" readonly>
    </div>
  </div>

  <div class="row">
    <div>
      <button type="button" onclick="startScan()">ìŠ¤ìº” ì‹œì‘</button>
    </div>
    <div>
      <button type="button" class="secondary" onclick="stopScan()">ì¤‘ì§€</button>
    </div>
  </div>

  <div style="margin-top:10px;">
    <video id="video" style="width:100%;border-radius:10px;border:1px solid #e5e7eb;"></video>
  </div>

  <hr style="margin:14px 0;">

  <div class="card" style="border:none;padding:0;margin:0;">
    <h4>íŒŒì‹±ëœ ê°’</h4>
    <div class="row">
      <div>
        <label>ì°½ê³ </label>
        <input id="f_ì°½ê³ " placeholder="ì˜ˆ: A" value="A">
      </div>
      <div>
        <label>ë¡œì¼€ì´ì…˜(ìœ„ì¹˜)</label>
        <input id="f_ë¡œì¼€ì´ì…˜" placeholder="ì˜ˆ: B01-01-02-A">
      </div>
    </div>

    <label>í’ˆë²ˆ</label>
    <input id="f_í’ˆë²ˆ">

    <label>í’ˆëª…</label>
    <input id="f_í’ˆëª…">

    <div class="row">
      <div>
        <label>LOT</label>
        <input id="f_LOT">
      </div>
      <div>
        <label>ê·œê²©</label>
        <input id="f_ê·œê²©">
      </div>
    </div>

    <div class="row">
      <div>
        <button type="button" onclick="goInbound()">ğŸ“¥ ì…ê³ ë¡œ</button>
      </div>
      <div>
        <button type="button" onclick="goMove()">ğŸ” ì´ë™ìœ¼ë¡œ</button>
      </div>
    </div>

    <p class="hint">â€» â€œí•´ë‹¹ ë¡œì¼€ì´ì…˜ ì¬ê³ â€ê°€ ì•„ë˜ì— ìë™ í‘œì‹œë©ë‹ˆë‹¤.</p>
    <div id="invBox"></div>
  </div>
</div>

<script src="https://unpkg.com/@zxing/library@latest"></script>
<script>
let codeReader;

function parsePairs(text){
  // supports "í‚¤:ê°’/í‚¤:ê°’" or JSON
  try{
    const obj = JSON.parse(text);
    if(obj && typeof obj === 'object') return obj;
  }catch(e){}
  const out = {};
  text.split(/[\/\n]+/).forEach(part=>{
    const idx = part.indexOf(":");
    if(idx>0){
      const k = part.slice(0, idx).trim();
      const v = part.slice(idx+1).trim();
      if(k) out[k]=v;
    }
  });
  return out;
}

async function loadInventory(){
  const wh = document.getElementById('f_ì°½ê³ ').value.trim();
  const loc = document.getElementById('f_ë¡œì¼€ì´ì…˜').value.trim();
  const box = document.getElementById('invBox');
  box.innerHTML = "";
  if(!wh || !loc) return;
  try{
    const res = await fetch(`/api/ì¬ê³ /ë¡œì¼€ì´ì…˜?ì°½ê³ =${encodeURIComponent(wh)}&ë¡œì¼€ì´ì…˜=${encodeURIComponent(loc)}`);
    const rows = await res.json();
    if(!Array.isArray(rows) || rows.length===0){
      box.innerHTML = "<div class='hint'>ì¬ê³  ì—†ìŒ</div>";
      return;
    }
    let html = "<table><thead><tr><th>í’ˆë²ˆ</th><th>LOT</th><th>ìˆ˜ëŸ‰</th></tr></thead><tbody>";
    for(const r of rows){
      html += `<tr><td>${r.í’ˆë²ˆ}</td><td>${r.LOT}</td><td>${r.ìˆ˜ëŸ‰}</td></tr>`;
    }
    html += "</tbody></table>";
    box.innerHTML = html;
  }catch(e){
    box.innerHTML = "<div class='hint'>ì¬ê³  ì¡°íšŒ ì˜¤ë¥˜</div>";
  }
}

function applyParsed(text){
  document.getElementById('qrText').value = text;
  const obj = parsePairs(text);

  // map keys (Korean variants)
  const loc = obj['ìœ„ì¹˜'] || obj['ë¡œì¼€ì´ì…˜'] || obj['LOCATION'] || obj['location'] || "";
  const code = obj['í’ˆë²ˆ'] || obj['item_code'] || obj['code'] || "";
  const name = obj['í’ˆëª…'] || obj['item_name'] || obj['name'] || "";
  const lot  = obj['LOT'] || obj['lot'] || "";
  const spec = obj['ê·œê²©'] || obj['spec'] || "";

  if(loc) document.getElementById('f_ë¡œì¼€ì´ì…˜').value = loc;
  if(code) document.getElementById('f_í’ˆë²ˆ').value = code;
  if(name) document.getElementById('f_í’ˆëª…').value = name;
  if(lot) document.getElementById('f_LOT').value = lot;
  if(spec) document.getElementById('f_ê·œê²©').value = spec;

  loadInventory();
}

function startScan(){
  codeReader = new ZXing.BrowserQRCodeReader();
  codeReader.decodeFromVideoDevice(null, 'video', (result, err) => {
    if (result) {
      applyParsed(result.text);
      // keep camera on for multiple scans (optional)
    }
  });
}

function stopScan(){
  if(codeReader) codeReader.reset();
}

function goInbound(){
  const q = new URLSearchParams({
    'ì°½ê³ ': document.getElementById('f_ì°½ê³ ').value,
    'ë¡œì¼€ì´ì…˜': document.getElementById('f_ë¡œì¼€ì´ì…˜').value,
    'í’ˆë²ˆ': document.getElementById('f_í’ˆë²ˆ').value,
    'í’ˆëª…': document.getElementById('f_í’ˆëª…').value,
    'LOT': document.getElementById('f_LOT').value,
    'ê·œê²©': document.getElementById('f_ê·œê²©').value,
    'ìˆ˜ëŸ‰': '1'
  });
  window.location.href = '/ì…ê³ ?' + q.toString();
}

function goMove(){
  const q = new URLSearchParams({
    'ì°½ê³ ': document.getElementById('f_ì°½ê³ ').value,
    'ì¶œë°œë¡œì¼€ì´ì…˜': document.getElementById('f_ë¡œì¼€ì´ì…˜').value,
    'ë„ì°©ë¡œì¼€ì´ì…˜': '',
    'í’ˆë²ˆ': document.getElementById('f_í’ˆë²ˆ').value,
    'LOT': document.getElementById('f_LOT').value,
    'ìˆ˜ëŸ‰': '1'
  });
  window.location.href = '/ì´ë™?' + q.toString();
}

document.getElementById('f_ì°½ê³ ').addEventListener('change', loadInventory);
document.getElementById('f_ë¡œì¼€ì´ì…˜').addEventListener('change', loadInventory);
</script>
{% endblock %}
