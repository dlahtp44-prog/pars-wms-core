<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="/static/app.css"/>
  <title>CS 관리 - PARS WMS</title>
  <style>
    table { width:100%; border-collapse:collapse; }
    th, td { border-bottom:1px solid #2a2f3a; padding:8px; font-size:12px; vertical-align:top; }
    th { text-align:left; }
    .row { display:flex; gap:8px; flex-wrap:wrap; }
    .row > * { flex:1; min-width:140px; }
    .tag { display:inline-block; padding:2px 8px; border:1px solid #2a2f3a; border-radius:999px; font-size:11px; }
  </style>
</head>
<body>
<div class="container">
  <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
      <div>
        <h1>CS 관리</h1>
        <div class="small">로그인: <b>{{ user.username }}</b> · <a href="/logout">로그아웃</a></div>
      </div>
      <div>
        <a class="tag" href="/api/cs/export.xlsx?year={{year}}&month={{month}}">엑셀 다운로드</a>
      </div>
    </div>

    <form method="get" action="/page/cs" class="row">
      <div>
        <label>연도</label>
        <input name="y" type="number" value="{{year}}" min="2000" max="2100">
      </div>
      <div>
        <label>월</label>
        <input name="m" type="number" value="{{month}}" min="1" max="12">
      </div>
      <div style="align-self:end;">
        <button type="submit">조회</button>
      </div>
    </form>

    <hr style="border:0;border-top:1px solid #2a2f3a; margin:12px 0;"/>

    <h3>등록</h3>
    <form id="createForm" class="row">
      <div><label>일자</label><input name="created_date" type="date" required></div>
      <div><label>고객</label><input name="customer" type="text"></div>
      <div><label>채널</label><input name="channel" type="text" placeholder="전화/카톡/메일"></div>
      <div><label>주문번호</label><input name="order_no" type="text"></div>
      <div><label>품번</label><input name="item_code" type="text"></div>
      <div><label>품명</label><input name="item_name" type="text"></div>
      <div><label>이슈유형</label><input name="issue_type" type="text" placeholder="파손/오출고/지연 등"></div>
      <div>
        <label>상태</label>
        <select name="status">
          <option value="open" selected>open</option>
          <option value="doing">doing</option>
          <option value="done">done</option>
        </select>
      </div>
      <div style="flex:2; min-width:240px;"><label>비고</label><input name="note" type="text"></div>
      <div style="align-self:end;"><button type="submit">등록</button></div>
    </form>
    <pre id="msg" class="small"></pre>

    <h3 style="margin-top:14px;">목록 ({{year}}-{{"%02d"|format(month)}})</h3>
    <div style="overflow:auto;">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>일자</th>
            <th>고객/채널</th>
            <th>주문/품목</th>
            <th>이슈</th>
            <th>상태</th>
            <th>비고</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
        {% for r in rows %}
          <tr>
            <td>{{ r.id }}</td>
            <td>{{ r.created_date }}</td>
            <td>{{ r.customer }}<br/><span class="small">{{ r.channel }}</span></td>
            <td><span class="small">{{ r.order_no }}</span><br/>{{ r.item_code }}<br/><span class="small">{{ r.item_name }}</span></td>
            <td>{{ r.issue_type }}</td>
            <td>{{ r.status }}</td>
            <td style="min-width:180px;">{{ r.note }}</td>
            <td><button onclick="delTicket({{r.id}})">삭제</button></td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>

    <p style="margin-top:12px;"><a href="/">← 메인</a></p>
  </div>
</div>

<script>
const msg=document.getElementById('msg');
document.getElementById('createForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  msg.textContent='';
  const fd=new FormData(e.target);
  const res=await fetch('/api/cs/create', {method:'POST', body:fd});
  if(!res.ok){
    msg.textContent='등록 실패: ' + (await res.text());
    return;
  }
  location.reload();
});

async function delTicket(id){
  if(!confirm('삭제할까요?')) return;
  const fd=new FormData();
  fd.append('id', id);
  const res=await fetch('/api/cs/delete', {method:'POST', body:fd});
  if(!res.ok){
    alert('삭제 실패');
    return;
  }
  location.reload();
}
</script>
</body>
</html>
