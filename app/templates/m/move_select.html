<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="/static/app.css"/>
  <title>제품 선택</title>
</head>
<body>
<div class="container">
  <div class="card">
    <h2>제품 선택</h2>
    <p class="small">출발 로케이션: <b>{{from_location}}</b></p>

    {% if rows|length == 0 %}
      <p>해당 로케이션에 재고가 없습니다.</p>
      <p class="small"><a href="/m/move/from">← 출발 로케이션 다시</a></p>
    {% else %}

      <form method="post" action="/m/move/select/submit" id="moveForm">
        <input type="hidden" name="from_location" value="{{from_location}}">

        <table>
          <thead>
            <tr>
              <th>선택</th>
              <th>브랜드</th>
              <th>품번</th>
              <th>LOT</th>
              <th>규격</th>
              <th style="text-align:right">재고</th>
            </tr>
          </thead>
          <tbody>
            {% for r in rows %}
              <tr>
                <td>
                  <input type="radio" name="pick" required
                         data-qty="{{r.qty}}"
                         value="{{r.warehouse}}|||{{r.brand}}|||{{r.item_code}}|||{{r.item_name}}|||{{r.lot}}|||{{r.spec}}">
                </td>
                <td>{{r.brand}}</td>
                <td>{{r.item_code}}</td>
                <td>{{r.lot}}</td>
                <td>{{r.spec}}</td>
                <td style="text-align:right">{{r.qty}}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>

        <div style="margin-top:12px;">
          <p class="small">선택 재고: <b id="availQty">-</b></p>

          <label>이동 수량</label>
          <input name="qty" id="qtyInput" type="number" min="1" step="1"
                 inputmode="numeric" pattern="[0-9]*"
                 placeholder="숫자만 입력" required>

          <label>작업자</label>
          <input name="operator" type="text" placeholder="예: 홍길동" required>

          <label>비고</label>
          <input name="note" type="text" placeholder="선택">

          <button type="submit">다음: 도착 로케이션 스캔</button>
        </div>
      </form>

      <p class="small"><a href="/m/move/from">← 출발 로케이션 다시</a></p>

      <script>
      (function(){
        const form = document.getElementById("moveForm");
        const avail = document.getElementById("availQty");
        const qtyInput = document.getElementById("qtyInput");

        let available = 0;

        document.querySelectorAll("input[name='pick']").forEach(r=>{
          r.addEventListener("change", ()=>{
            available = parseInt(r.dataset.qty || "0", 10);
            avail.textContent = available;
            qtyInput.max = available || "";
            if(available > 0 && parseInt(qtyInput.value||"0",10) > available){
              qtyInput.value = available;
            }
          });
        });

        form.addEventListener("submit", (e)=>{
          const q = parseInt(qtyInput.value||"0",10);
          if(!available){
            alert("제품을 선택하세요.");
            e.preventDefault();
            return;
          }
          if(q <= 0 || q > available){
            alert("수량이 재고를 초과했습니다.");
            e.preventDefault();
          }
        });
      })();
      </script>

    {% endif %}
  </div>
</div>
</body>
</html>
